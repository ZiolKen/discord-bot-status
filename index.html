<!DOCTYPE html>
<html lang="en">

<head>
  <meta charSet="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta content="ie=edge" http-equiv="X-UA-Compatible" />
  <link rel="icon" type="image/png" href="assets/ico.png" />
  <title>ZiolKen | Bot Status</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preload" href="https://challenges.cloudflare.com/turnstile/v0/api.js" as="script" />
  <meta name="theme-color" content="#000000" />
  <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" rel="stylesheet" /> -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-java.min.js"></script>
  <link rel="manifest" href="assets/manifest.json" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/ico.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="assets/ico.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="assets/ico.png" />
  <meta name="description" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Discord bot status, current system info & status, real-time update. ‚Ä¢ @ZiolKen." />
  <meta name="author" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Bot Status" />
  <meta property="og:title" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Bot Status" />
  <meta property="og:description" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Discord bot status, current system info & status, real-time update. ‚Ä¢ @ZiolKen." />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Bot Status" />
  <meta name="twitter:description" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Discord bot status, current system info & status, real-time update. ‚Ä¢ @ZiolKen." />
  <link rel="stylesheet" href="style.css" />
  <meta name="apple-mobile-web-app-title" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Bot Status" />
  <meta name="mobile-web-app-title" content="@„Ç∏„Ç™„É´„Ç±„É≥ | Bot Status" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
</head>

<body>
<header class="container">
  <div class="Header">
      <img src="https://files.catbox.moe/0zucxv.png" alt="BOTSTATUS">
      <button class="ibtn"><a href="https://discord.com/oauth2/authorize?client_id=1398238289500307578&scope=bot&permissions=8" target="_blank"><img src="./assets/discord.png"></a></button>
  </div>

  <div id="global-status" class="status-banner loading">
    <span class="pulse"></span>
    <span id="global-text">Checking system status‚Ä¶</span>
  </div>
</header>

<main class="container">

  <!-- SUMMARY -->
  <section class="summary">
    <div class="card"><span>Ping</span><strong id="ping">--</strong></div>
    <div class="card"><span>Uptime</span><strong id="uptime">--</strong></div>
    <div class="card"><span>Servers</span><strong id="guilds">--</strong></div>
    <div class="card"><span>Users</span><strong id="users">--</strong></div>
  </section>

  <!-- SERVICES -->
  <section class="card">
    <h2>‚öôÔ∏è Services</h2>
    <div id="service-gateway" class="service-card"></div>
    <div id="service-api" class="service-card"></div>
    <div id="service-commands" class="service-card"></div>
  </section>

  <!-- INCIDENTS -->
  <section class="card">
    <h2>üö® Incidents</h2>
    <div id="incidents">Loading‚Ä¶</div>
  </section>

  <!-- CHART -->
  <section class="card">
    <h2>üìâ Ping History</h2>
    <canvas id="pingChart" height="90"></canvas>
  </section>

  <!-- TECH -->
  <section class="card tech">
    <h2>üîß Technical Information</h2>
    <div class="tech-grid">
      <div><span>Last update</span><b id="updated">--</b></div>
      <div><span>Last boot</span><b id="boot">--</b></div>
      <div><span>Average ping</span><b id="ping-tech">--</b></div>
      <div><span>Bot Ver</span><b>1.3.2</b></div>
      <div><span>Node.js</span><b>20.20.0</b></div>
      <div><span>discord.js</span><b>14.25.1</b></div>
    </div>
  </section>

</main>

<footer>
  ¬© 2025 ZiolKen ‚Ä¢ Status Page
</footer>

<script>
const STATUS_URL = "https://discord-bot-us.onrender.com/status";
const INCIDENTS_URL = "https://discord-bot-us.onrender.com/incidents";

function normalizeState(state) {
  if (["online", "operational", "up"].includes(state)) return "online";
  if (["degraded", "partial"].includes(state)) return "degraded";
  return "down";
}

const pingHistory = [];
const MAX = 30;

const chart = new Chart(
  document.getElementById("pingChart"), {
    type:"line",
    data:{ labels:[], datasets:[{ data:[], borderWidth:2, tension:.4 }]},
    options:{ plugins:{ legend:{display:false}}, scales:{ x:{display:false}}}
  }
);

function chartPush(p) {
  if (pingHistory.length >= MAX) pingHistory.shift();
  pingHistory.push(p);
  chart.data.labels = pingHistory.map((_,i)=>i);
  chart.data.datasets[0].data = pingHistory;
  chart.update();
}

function isOfflineStatus(s) {
  return s && s.status === "offline";
}

/* ===== UPTIME ===== */
const stats = {
  gateway:{up:0,down:0},
  api:{up:0,down:0},
  commands:{up:0,down:0}
};

const uptime = s => {
  const t=s.up+s.down;
  return t===0?"100%":((s.up/t)*100).toFixed(2)+"%";
};

function fmtTime(t) {
  return new Date(t).toLocaleString();
}

function duration(start, end) {
  const ms = new Date(end) - new Date(start);
  const m = Math.floor(ms / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  return `${m}m ${s}s`;
}

function fetchWithTimeout(url, timeout = 1000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);

  return fetch(url, { signal: controller.signal })
    .finally(() => clearTimeout(id));
}

/* ===== RENDER ===== */
function getDegradedServices(incidents) {
  const set = new Set();

  incidents.forEach(i => {
    if (!i.resolvedAt && i.status !== "resolved") {
      set.add(i.service);
    }
  });

  return set;
}

function applyIncidentState(serviceName, baseState, degradedSet) {
  if (baseState !== "online") return baseState;
  return degradedSet.has(serviceName) ? "degraded" : "online";
}

function renderService(id, name, state) {
  state === "online"
    ? stats[id].up++
    : stats[id].down++;

  const label =
    state === "online"
      ? "‚Ä¢ Operational"
      : state === "degraded"
      ? "‚Ä¢ Degraded"
      : "‚Ä¢ Down";

  document.getElementById(`service-${id}`).innerHTML = `
    <div>
      <div class="service-name">${name}</div>
      <div class="service-meta">Uptime: ${uptime(stats[id])}</div>
    </div>
    <div class="service-status ${state}">
      ${label}
    </div>`;
}

function renderGlobal(status, incidents) {
  const box = document.getElementById("global-status");
  const text = document.getElementById("global-text");

  let cls="ok", msg="All Systems Operational";

  if (status.status === "down") {
    cls="down";
    msg="Major System Outage";
  } else if (
    status.status === "degraded" ||
    incidents.some(i => !i.resolvedAt)
  ) {
    cls="degraded";
    msg="Partial System Outage";
  }

  box.className = `status-banner ${cls}`;
  text.textContent = msg;
}

function renderOffline() {
  ["ping","ping-tech","uptime","guilds","users","updated","boot"]
    .forEach(id => document.getElementById(id).textContent = "--");

  renderService("gateway", "Discord Gateway", "down");
  renderService("api", "API Endpoint", "down");
  renderService("commands", "Command System", "down");

  const box = document.getElementById("global-status");
  box.className = "status-banner down";
  document.getElementById("global-text").textContent =
    "Major System Outage";
}

function renderIncidents(list) {
  const el = document.getElementById("incidents");

  if (!list || !list.length) {
    el.innerHTML = `<div class="incident-empty">No incidents</div>`;
    return;
  }

  el.innerHTML = `<div class="incident-list"></div>`;
  const wrap = el.firstChild;

  list
    .sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt))
    .forEach(i => {
      const resolved = i.status === "resolved";
      const dur = resolved
        ? duration(i.startedAt, i.resolvedAt)
        : "Ongoing";

      wrap.innerHTML += `
        <div class="incident-item ${resolved ? "resolved" : "active"}">
          <span class="incident-dot"></span>

          <div class="incident-title">
            ${i.title}
            <span class="incident-badge ${resolved ? "resolved" : "active"}">
              ${resolved ? "Resolved" : "Resolving"}
            </span>
          </div>

          <div class="incident-meta">
            Service: <b>${i.service.toUpperCase()}</b>
          </div>

          <div class="incident-time">
            Started: ${fmtTime(i.startedAt)}<br>
            ${resolved ? `Resolved: ${fmtTime(i.resolvedAt)}<br>` : ""}
            Duration: ${dur}
          </div>
        </div>
      `;
    });
}

/* ===== LOAD ===== */
async function load() {
  try {
    const [s, incidents] = await Promise.all([
      fetchWithTimeout(STATUS_URL).then(r => r.json()),
      fetchWithTimeout(INCIDENTS_URL).then(r => r.json())
    ]);

    if (isOfflineStatus(s)) {
      renderOffline();
      renderIncidents(incidents);
      return;
    }

    document.getElementById("ping").textContent = `${Math.round(s.ping)} ms`;
    document.getElementById("ping-tech").textContent = `${Math.round(s.ping)} ms`;
    document.getElementById("uptime").textContent = s.uptime;
    document.getElementById("guilds").textContent = s.guilds;
    document.getElementById("users").textContent = s.users;

    document.getElementById("updated").textContent =
      new Date(s.updated).toLocaleString();

    document.getElementById("boot").textContent =
      new Date(s.lastBoot).toLocaleString();

    chartPush(s.ping);

    const degradedSet = getDegradedServices(incidents);

    const hostState = applyIncidentState(
      "host",
      normalizeState(s.hostService),
      degradedSet
    );

    const gatewayState = applyIncidentState(
      "gateway",
      normalizeState(s.services.gateway),
      degradedSet
    );

    const apiState = applyIncidentState(
      "api",
      normalizeState(s.services.api),
      degradedSet
    );

    const commandState = applyIncidentState(
      "commands",
      normalizeState(s.services.commands),
      degradedSet
    );

    renderService("gateway", "Discord Gateway", gatewayState);
    renderService("api", "API Endpoint", apiState);
    renderService("commands", "Command System", commandState);

    renderIncidents(incidents);

    renderGlobal({ hostService: hostState }, incidents);

  } catch (e) {
    console.error(e);
    const box = document.getElementById("global-status");
    box.className = "status-banner down";
    document.getElementById("global-text").textContent =
      "Status service unreachable";
  }
}

load();
setInterval(load,5000);
load();
</script>

</body>

</html>